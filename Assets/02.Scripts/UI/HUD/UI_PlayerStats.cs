using UnityEngine;
using UnityEngine.UI;

/// <summary>
/// í”Œë ˆì´ì–´ ìŠ¤íƒ¯ UIë¥¼ ê´€ë¦¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
/// ì²´ë ¥ë°”, ìŠ¤íƒœë¯¸ë‚˜ë°” ë“±ì„ í‘œì‹œí•©ë‹ˆë‹¤.
/// 
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ“š í•™ìŠµ í¬ì¸íŠ¸: ì˜µì €ë²„ íŒ¨í„´ì˜ êµ¬ë…ì (Subscriber)
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// 
/// ë¹„ìœ : "ìœ íŠœë¸Œ êµ¬ë…ì"
/// 
/// 1. Start()ì—ì„œ êµ¬ë… ë“±ë¡ (ì•Œë¦¼ ì„¤ì • ON)
///    PlayerStats.OnDataChanged += Refresh;
/// 
/// 2. ìŠ¤íƒ¯ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ Refresh() í˜¸ì¶œ (ì•Œë¦¼ ìˆ˜ì‹ )
/// 
/// 3. OnDestroy()ì—ì„œ êµ¬ë… í•´ì œ (ì•Œë¦¼ ì„¤ì • OFF)
///    PlayerStats.OnDataChanged -= Refresh;
/// 
/// êµ¬ë… í•´ì œë¥¼ ì•ˆ í•˜ë©´?
/// - ì´ë¯¸ íŒŒê´´ëœ UIê°€ ê³„ì† í˜¸ì¶œë¨
/// - NullReferenceException ë°œìƒ!
/// - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜!
/// 
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// </summary>
public class UI_PlayerStats : MonoBehaviour
{
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // í•„ë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    [SerializeField, Tooltip("í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ì°¸ì¡°")]
    private PlayerStats _stats;
    
    [SerializeField, Tooltip("ì²´ë ¥ ìŠ¬ë¼ì´ë”")]
    private Slider _healthSlider;
    
    [SerializeField, Tooltip("ìŠ¤íƒœë¯¸ë‚˜ ìŠ¬ë¼ì´ë”")]
    private Slider _staminaSlider;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Unity ìƒëª…ì£¼ê¸°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private void Start()
    {
        ValidateReferences();
        SubscribeToEvents();
        Refresh();
        
        Debug.Log("[UI_PlayerStats] ì´ˆê¸°í™” ì™„ë£Œ - ì´ë²¤íŠ¸ êµ¬ë…ë¨");
    }

    private void OnDestroy()
    {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“š í•µì‹¬: ì •ì  ì´ë²¤íŠ¸ êµ¬ë… í•´ì œ
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 
        // ì™œ ì¤‘ìš”í•œê°€ìš”?
        // 
        // ì •ì  ì´ë²¤íŠ¸ëŠ” ì”¬ì´ ë°”ë€Œì–´ë„ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.
        // UI ì˜¤ë¸Œì íŠ¸ê°€ íŒŒê´´ë˜ì–´ë„ ì´ë²¤íŠ¸ì— ë“±ë¡ëœ ì°¸ì¡°ëŠ” ë‚¨ì•„ìˆì–´ì„œ
        // ì´ë¯¸ ì—†ì–´ì§„ UIì˜ Refresh()ë¥¼ ê³„ì† í˜¸ì¶œí•˜ë ¤ê³  í•©ë‹ˆë‹¤.
        // 
        // ê²°ê³¼:
        // - NullReferenceException ë°œìƒ
        // - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ (Garbage Collection ë¶ˆê°€)
        // 
        // ë¹„ìœ : "ì´ì‚¬ ê°”ëŠ”ë° ìš°í¸ë¬¼ì´ ê³„ì† ì „ ì£¼ì†Œë¡œ ê°"
        // - ìƒˆ ì£¼ì¸: "ì´ê±° ëˆ„êµ¬ ê±°ì˜ˆìš”?" (ì—ëŸ¬)
        // - ìš°í¸í•¨ ìŒ“ì„ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜)
        // 
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        UnsubscribeFromEvents();
        Debug.Log("[UI_PlayerStats] íŒŒê´´ë¨ - ì´ë²¤íŠ¸ êµ¬ë… í•´ì œë¨");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ˆê¸°í™” ë©”ì„œë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// Inspectorì—ì„œ ì°¸ì¡°ê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    /// </summary>
    private void ValidateReferences()
    {
        if (_stats == null)
        {
            Debug.LogError("[UI_PlayerStats] PlayerStats ì°¸ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤! Inspectorì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
        }
        
        if (_healthSlider == null)
        {
            Debug.LogError("[UI_PlayerStats] Health Slider ì°¸ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤!");
        }
        
        if (_staminaSlider == null)
        {
            Debug.LogError("[UI_PlayerStats] Stamina Slider ì°¸ì¡°ê°€ ì—†ìŠµë‹ˆë‹¤!");
        }
    }

    /// <summary>
    /// ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.
    /// </summary>
    private void SubscribeToEvents()
    {
        PlayerStats.OnDataChanged += Refresh;
    }

    /// <summary>
    /// ì´ë²¤íŠ¸ êµ¬ë…ì„ í•´ì œí•©ë‹ˆë‹¤.
    /// </summary>
    private void UnsubscribeFromEvents()
    {
        PlayerStats.OnDataChanged -= Refresh;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI ê°±ì‹ 
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// UIë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// ğŸ“š í•™ìŠµ í¬ì¸íŠ¸: í’€ë§(Polling) vs ì´ë²¤íŠ¸(Event)
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// 
    /// Polling ë°©ì‹ (ë¹„íš¨ìœ¨ì ):
    /// void Update() {
    ///     Refresh();  // ë§¤ í”„ë ˆì„ë§ˆë‹¤ UI ê°±ì‹ 
    /// }
    /// 
    /// ë¬¸ì œì :
    /// - 60FPSë¼ë©´ ì´ˆë‹¹ 60ë²ˆ ê°±ì‹ 
    /// - ê°’ì´ ì•ˆ ë°”ë€Œì–´ë„ ê³„ì† ê°±ì‹ 
    /// - CPU ë‚­ë¹„!
    /// 
    /// Event ë°©ì‹ (íš¨ìœ¨ì  - í˜„ì¬ ì½”ë“œ):
    /// PlayerStats.OnDataChanged += Refresh;
    /// 
    /// ì¥ì :
    /// - ê°’ì´ ë°”ë€” ë•Œë§Œ ê°±ì‹ 
    /// - í•„ìš”í•  ë•Œë§Œ CPU ì‚¬ìš©
    /// - ì„±ëŠ¥ ìµœì í™”!
    /// 
    /// ë¹„ìœ : 
    /// - Polling = ë§¤ ì´ˆë§ˆë‹¤ ë¬¸ ì—´ì–´ë³´ê¸° "íƒë°° ì™”ë‚˜?"
    /// - Event = ì´ˆì¸ì¢… ìš¸ë¦¬ë©´ ë¬¸ ì—´ê¸°
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// </summary>
    public void Refresh()
    {
        if (_stats == null)
        {
            return;
        }

        RefreshHealthBar();
        RefreshStaminaBar();
    }

    /// <summary>
    /// ì²´ë ¥ë°”ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
    /// </summary>
    private void RefreshHealthBar()
    {
        if (_healthSlider == null)
        {
            return;
        }
        
        // Slider.valueëŠ” 0~1 ë²”ìœ„ì˜ ì •ê·œí™”ëœ ê°’
        _healthSlider.value = CalculatePercent(_stats.Health.Value, _stats.Health.MaxValue);
    }

    /// <summary>
    /// ìŠ¤íƒœë¯¸ë‚˜ë°”ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
    /// </summary>
    private void RefreshStaminaBar()
    {
        if (_staminaSlider == null)
        {
            return;
        }
        
        _staminaSlider.value = CalculatePercent(_stats.Stamina.Value, _stats.Stamina.MaxValue);
    }

    /// <summary>
    /// ë°±ë¶„ìœ¨ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    /// </summary>
    /// <param name="current">í˜„ì¬ê°’</param>
    /// <param name="max">ìµœëŒ€ê°’</param>
    /// <returns>0~1 ë²”ìœ„ì˜ ë°±ë¶„ìœ¨</returns>
    private float CalculatePercent(float current, float max)
    {
        // 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
        if (max <= 0f)
        {
            return 0f;
        }
        
        return Mathf.Clamp01(current / max);
    }
}

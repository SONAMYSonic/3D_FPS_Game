using UnityEngine;
using System;

/// <summary>
/// í”Œë ˆì´ì–´ì˜ ìŠ¤íƒ¯ì„ ê´€ë¦¬í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.
/// 
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ“š í•™ìŠµ í¬ì¸íŠ¸: ì˜µì €ë²„ íŒ¨í„´ (Observer Pattern)
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// 
/// ë¹„ìœ : "ìœ íŠœë¸Œ êµ¬ë… ì‹œìŠ¤í…œ"
/// 
/// - ìœ íŠœë²„(Publisher): PlayerStats, ConsumableStat
/// - êµ¬ë…ì(Subscriber): UI_PlayerStats
/// - ì•Œë¦¼(Notify): OnDataChanged ì´ë²¤íŠ¸ ë°œí–‰
/// 
/// êµ¬ë…ìê°€ ì§ì ‘ "ìƒˆ ì˜ìƒ ì˜¬ë¼ì™”ë‚˜?" ë§¤ë²ˆ í™•ì¸í•˜ì§€ ì•Šê³ ,
/// ìœ íŠœë²„ê°€ ì˜ìƒ ì˜¬ë¦¬ë©´ êµ¬ë…ìì—ê²Œ ì•Œë¦¼ì´ ê°!
/// 
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// 
/// 
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// ğŸ“š í•™ìŠµ í¬ì¸íŠ¸: ì´ë²¤íŠ¸ ì—°ê²° êµ¬ì¡°
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// 
/// ë¬¸ì œ ìƒí™©:
/// ConsumableStat._onDataChanged (ì¸ìŠ¤í„´ìŠ¤) â† ì—°ê²° ì•ˆ ë¨
/// PlayerStats.OnDataChanged (ì •ì )        â† UIê°€ êµ¬ë… ì¤‘
/// 
/// í•´ê²°:
/// ConsumableStatì˜ ê°’ ë³€ê²½
///       â†“ (ì¸ìŠ¤í„´ìŠ¤ ì½œë°± í˜¸ì¶œ)
/// PlayerStatsì˜ HandleStatChanged() ì‹¤í–‰
///       â†“ (ì •ì  ì´ë²¤íŠ¸ ë°œí–‰)
/// UI_PlayerStats.Refresh() ì‹¤í–‰
/// 
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// </summary>
public class PlayerStats : MonoBehaviour
{
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ìŠ¤íƒ¯ í•„ë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    public ConsumableStat Health;
    public ConsumableStat Stamina;
    public ConsumableStat Bomb;
    public ValueStat Damage;
    public ValueStat MoveSpeed;
    public ValueStat RunSpeed;
    public ValueStat JumpPower;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ë²¤íŠ¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /// <summary>
    /// ìŠ¤íƒ¯ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ ë°œí–‰ë˜ëŠ” ì´ë²¤íŠ¸ì…ë‹ˆë‹¤.
    /// UI ë“± ì™¸ë¶€ì—ì„œ êµ¬ë…í•˜ì—¬ ë³€ê²½ ì‚¬í•­ì„ ê°ì§€í•©ë‹ˆë‹¤.
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// ğŸ“š ì™œ static ì´ë²¤íŠ¸ì¸ê°€ìš”?
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// 
    /// - ì‹±ê¸€í†¤ íŒ¨í„´ì²˜ëŸ¼ í”Œë ˆì´ì–´ëŠ” ê²Œì„ì— 1ëª…ë§Œ ì¡´ì¬
    /// - UIê°€ PlayerStats ì¸ìŠ¤í„´ìŠ¤ ì°¸ì¡° ì—†ì´ë„ êµ¬ë… ê°€ëŠ¥
    /// - ë‹¨, ì”¬ ì „í™˜ ì‹œ êµ¬ë… í•´ì œ ì£¼ì˜ í•„ìš”!
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// </summary>
    public static event Action OnDataChanged;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ê³¨ë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    [Header("ê³¨ë“œ")]
    [SerializeField] private int _currentGold = 0;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ë””ë¯¸í„° ë²•ì¹™ ì¤€ìˆ˜: í”„ë¡œí¼í‹°/ë©”ì„œë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ì²´ë ¥ ê´€ë ¨
    public bool IsDead => Health.Value <= 0f;
    public float CurrentHealth => Health.Value;
    public float MaxHealth => Health.MaxValue;
    public float HealthPercent => Health.Value / Health.MaxValue;
    public void DecreaseHealth(float amount) => Health.Decrease(amount);

    // ì´ë™ ê´€ë ¨
    public float MoveSpeedValue => MoveSpeed.Value;
    public float RunSpeedValue => RunSpeed.Value;
    public float JumpPowerValue => JumpPower.Value;

    // ìŠ¤íƒœë¯¸ë‚˜ ê´€ë ¨
    public bool TryConsumeStamina(float amount) => Stamina.TryConsume(amount);

    // ê³¨ë“œ ê´€ë ¨
    public int CurrentGold => _currentGold;
    
    public void AddGold(int amount)
    {
        _currentGold += amount;
        NotifyDataChanged();
    }
    
    public bool TrySpendGold(int amount)
    {
        if (_currentGold < amount)
        {
            return false;
        }
        
        _currentGold -= amount;
        NotifyDataChanged();
        return true;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Unity ìƒëª…ì£¼ê¸°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    private void Start()
    {
        InitializeStats();
    }

    private void Update()
    {
        RegenerateStats();
    }

    private void OnDestroy()
    {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“š í•™ìŠµ í¬ì¸íŠ¸: ì •ì  ì´ë²¤íŠ¸ ì •ë¦¬ì˜ ì¤‘ìš”ì„±
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 
        // ì •ì  ì´ë²¤íŠ¸ëŠ” ì”¬ì´ ë°”ë€Œì–´ë„ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ìˆìŒ!
        // êµ¬ë… í•´ì œí•˜ì§€ ì•Šìœ¼ë©´ "ë©”ëª¨ë¦¬ ëˆ„ìˆ˜" ë°œìƒ
        // 
        // ë¹„ìœ : "êµ¬ë… ì·¨ì†Œ ì•ˆ í•œ ë„·í”Œë¦­ìŠ¤"
        // - ì•ˆ ë³´ëŠ”ë°ë„ ë§¤ë‹¬ ëˆ ë¹ ì ¸ë‚˜ê° (ë©”ëª¨ë¦¬ ë‚­ë¹„)
        // - ì´ë¯¸ ì—†ì–´ì§„ UIê°€ ê³„ì† í˜¸ì¶œë¨ (NullReferenceException)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        OnDataChanged = null;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ˆê¸°í™”
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// ëª¨ë“  ìŠ¤íƒ¯ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// ğŸ“š í•µì‹¬ ìˆ˜ì •: ì½œë°± í•¨ìˆ˜ ì—°ê²°
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// 
    /// ë³€ê²½ ì „ (ë¬¸ì œ):
    /// Health.Initialize();  // êµ¬ë…ì ì—†ì´ ì´ˆê¸°í™”
    /// 
    /// ë³€ê²½ í›„ (í•´ê²°):
    /// Health.Initialize(HandleStatChanged);  // ì½œë°± ì—°ê²°!
    /// 
    /// ì´ì œ Health ê°’ì´ ë°”ë€Œë©´:
    /// 1. Health._onDataChanged í˜¸ì¶œ
    /// 2. â†’ HandleStatChanged() ì‹¤í–‰
    /// 3. â†’ OnDataChanged ì •ì  ì´ë²¤íŠ¸ ë°œí–‰
    /// 4. â†’ UI_PlayerStats.Refresh() ì‹¤í–‰
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// </summary>
    private void InitializeStats()
    {
        // ê° ConsumableStatì— ì½œë°± í•¨ìˆ˜ ë“±ë¡
        // HandleStatChangedê°€ í˜¸ì¶œë˜ë©´ ì •ì  ì´ë²¤íŠ¸ OnDataChanged ë°œí–‰
        Health.Initialize(HandleStatChanged);
        Stamina.Initialize(HandleStatChanged);
        Bomb.Initialize(HandleStatChanged);
        
        Debug.Log("[PlayerStats] ìŠ¤íƒ¯ ì´ˆê¸°í™” ì™„ë£Œ - ì½œë°± ì—°ê²°ë¨");
    }

    /// <summary>
    /// ë§¤ í”„ë ˆì„ ìŠ¤íƒ¯ì„ ì¬ìƒì„±í•©ë‹ˆë‹¤.
    /// </summary>
    private void RegenerateStats()
    {
        float deltaTime = Time.deltaTime;

        Health.Regenerate(deltaTime);
        Stamina.Regenerate(deltaTime);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì´ë²¤íŠ¸ ì²˜ë¦¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// ConsumableStatì˜ ê°’ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” ì½œë°±ì…ë‹ˆë‹¤.
    /// ì •ì  ì´ë²¤íŠ¸ OnDataChangedë¥¼ ë°œí–‰í•˜ì—¬ UIì— ì•Œë¦½ë‹ˆë‹¤.
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// ğŸ“š í•™ìŠµ í¬ì¸íŠ¸: ë¸Œë¦¿ì§€ íŒ¨í„´ (Bridge)
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// 
    /// ì´ ë©”ì„œë“œëŠ” "ë‹¤ë¦¬" ì—­í• ì„ í•©ë‹ˆë‹¤:
    /// 
    /// ConsumableStat (ì¸ìŠ¤í„´ìŠ¤ ì´ë²¤íŠ¸)
    ///        â†“
    ///   HandleStatChanged (ë‹¤ë¦¬)
    ///        â†“
    /// OnDataChanged (ì •ì  ì´ë²¤íŠ¸) â†’ UI
    /// 
    /// ì™œ ì§ì ‘ ì—°ê²° ì•ˆ í•˜ë‚˜ìš”?
    /// - ConsumableStatì€ Actionì„ ë°›ìŒ (ì¸ìŠ¤í„´ìŠ¤ ì½œë°±)
    /// - OnDataChangedëŠ” static event (ì •ì )
    /// - íƒ€ì…ì´ ë‹¬ë¼ì„œ ì§ì ‘ ì—°ê²° ë¶ˆê°€!
    /// 
    /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /// </summary>
    private void HandleStatChanged()
    {
        NotifyDataChanged();
    }

    /// <summary>
    /// ë°ì´í„° ë³€ê²½ì„ êµ¬ë…ìë“¤ì—ê²Œ ì•Œë¦½ë‹ˆë‹¤.
    /// </summary>
    private void NotifyDataChanged()
    {
        OnDataChanged?.Invoke();
    }
}
